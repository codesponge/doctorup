#!/usr/bin/env ruby
begin
  require File.join(ENV['HOME'],%w[lib ruby gems doctorup lib doctorup])
  #require 'doctorup'
rescue LoadError
  #require 'rubygems'
  #require 'doctorup'
end

doctor = DoctorUp.new


if %w(--version -v).include? ARGV.first
  puts "doctorup 0.1.1"
  exit(0)
end


#TODO Cleanup option parsing
opts = OptionParser.new do |opts|

  opts.banner = "Usage doctorup [options] [textile_file]"
  opts.separator "If no file specified, STDIN will be used. If you are typing input, you can send an EOF by pressing ^D (^Z on Windows)"
  opts.separator ""
  opts.separator "To use: pass in a textile file.  If you want to include syntax highlighted snippets of code wrap them in"
  opts.separator "<code lang='lang_name'></code> tags where lang_name is the name of a programing language."
  opts.separator ""
  opts.separator "to see all the languages available do"
  opts.separator "  doctorup --languages"
  opts.separator "\n\nOPTIONS"
  opts.on("-t,","--theme NAME","Use ultraviolet theme THEME.") do |theme|
    doctor.options[:theme] = theme if Snippet.theme_available?(theme)
  end
  opts.on("--themes","List Available themes and exit") do
    puts Snippet.syntax_themes
    exit(0)
  end
  opts.on("--languages","List Available languages and exit") do
    puts Snippet.syntax_languages
    exit(0)
  end

  opts.on("--[no-]info_bar","Use an info bar in output?") do |ib|
    doctor.options[:info_bar] = ib
  end

  opts.on("--yaml_options", "Output options as yaml and exit") do
    puts DoctorUp.options.to_yaml
    exit(0)
  end

end #optparse


opts.parse! ARGV

input = ARGF.read


page = doctor.process(input)

doctemp = <<-HTML
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Doctored</title>
#{page[:head]}
<link rel="stylesheet" href="http://ssss.heroku.com/codesponge_articles.css" type="text/css" media="screen" charset="utf-8" />
</head>
<body>
  <div id="main_content">
  #{page[:body];}
  </div>
</body>
</html>
HTML

print doctemp